<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold mb-0">Marcas</h2>
  </div>

  <!-- Tabela -->
  <div class="d-flex justify-content-center mt-2">
    <div class="card shadow-sm rounded-4 w-100" style="max-width: 80%;">
      <div class="card-body">
        <div class="table-responsive">
          <h4 class="mb-4">Análise de Marcas.</h4>

          <table class="table table-hover align-middle mb-0 table-striped">
            <thead class="table-light">
              <tr>
                <th>Código</th>
                <th>Nome</th>
                <th>Modelos</th>
              </tr>
            </thead>
            <tbody>
              <% @marcas.each do |marca| %>
                <% qt = @qtd_veiculos[marca.id].to_i %>
                <% next if qt <= 0 %>
                <tr>
                  <td><%= marca.codigo %></td>
                  <td><%= marca.nome %></td>
                  <td><%= qt %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráfico -->
  <div class="d-flex justify-content-center mt-4">
    <div class="card shadow-sm rounded-4 w-100" style="max-width: 80%;">
      <div class="card-body">
        <h5 class="mb-3">
          <i class="fas fa-chart-bar me-2 text-secondary"></i>
          Preço médio por Marca
        </h5>

        <!-- Use aspas simples e raw/json_escape para evitar problemas de parsing -->
        <canvas id="graficoMediaMarcas" height="90"
          data-labels='<%= raw json_escape(@labels.to_json) %>'
          data-values='<%= raw json_escape(@values.to_json) %>'></canvas>
      </div>
    </div>
  </div>
</div>

<% content_for :scripts do %>
  <script>
    document.addEventListener('turbo:load', function(){
      const canvas = document.getElementById('graficoMediaMarcas');
      if(!canvas) return;
    });

    (function initGrafico(){
      // Se você usa Turbo/Hotwire, prenda no evento correto:
      // document.addEventListener('turbo:load', initGrafico)  // e mova o corpo para dentro
      const canvas = document.getElementById('graficoMediaMarcas');
      if(!canvas) return;

      const labels = JSON.parse(canvas.dataset.labels || '[]');
      const values = JSON.parse(canvas.dataset.values || '[]');

      // Debug opcional:
      // console.log({labels, values});

      if (!labels.length || !values.length) return; // sem dados, não renderiza

      const ctx = canvas.getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Preço médio (R$)',
            data: values
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: true } },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { callback: v => 'R$ ' + Number(v).toLocaleString('pt-BR') }
            }
          }
        }
      });
    })();
  </script>
<% end %>
